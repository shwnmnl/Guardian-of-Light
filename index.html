<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

    <title>Guardian of Light</title>
    <meta name="description" content="An ambient, time-shifting guardian that watches the light and whispers in a gothic, solarpunk tone." />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

    <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
      }
    }
    </script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap");

      :root {
        --scroll-frame: url("./assets/stuff/scroll.png");
        --ink: rgba(42, 25, 10, 0.92);
        --ink-soft: rgba(42, 25, 10, 0.70);
      }

      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        width: 100%;
        overflow: hidden;
      }

      body {
        background: var(--bg) center/cover no-repeat fixed;
        font-family: system-ui, sans-serif;
        -webkit-text-size-adjust: 100%;
      }

      .layout {
        height: 100%;
        display: grid;
        grid-template-columns: 1fr 1fr;
        align-items: stretch;
      }

      .left {
        padding: clamp(16px, 4vw, 48px);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .right { position: relative; overflow: hidden; min-height: 280px; }
      canvas { width: 100%; height: 100%; display: block; }

      .scroll-ui {
        width: min(720px, 92vw);
        aspect-ratio: 720 / 420;
        position: relative;
        user-select: none;
        font-family: "Press Start 2P", system-ui, sans-serif;
        background-image: var(--scroll-frame);
        background-repeat: no-repeat;
        background-position: center;
        background-size: 100% 100%;
        filter: drop-shadow(0 18px 32px rgba(0,0,0,0.35));
        margin-right: clamp(-200px, -12vw, -40px);
      }

      .scroll-inner {
        position: absolute;
        inset: clamp(46px, 6vw, 72px) clamp(74px, 10vw, 120px) clamp(60px, 8vw, 90px) clamp(74px, 10vw, 120px);
        display: flex;
        flex-direction: column;
        color: var(--ink);
      }

      .scroll-title {
        margin-top: 10px;
        font-size: clamp(10px, 1.6vw, 13px);
        margin-bottom: 6px;
        text-align: center;
      }

      #telemetry { font-size: 8px; opacity: 0.5; margin-left: 8px; }

      .scroll-subtitle {
        font-size: clamp(7px, 1.2vw, 9px);
        margin-bottom: 10px;
        opacity: 0.8;
        text-align: center;
      }

      .scroll-text {
        flex: 1;
        font-size: clamp(9px, 1.6vw, 12px);
        line-height: 1.9;
        white-space: pre-wrap;
        overflow-y: auto;
        padding-right: 10px;
        text-align: left;
      }

      .scroll-footer {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .scroll-hint { font-size: clamp(7px, 1.2vw, 9px); color: var(--ink-soft); }
      .scroll-cursor { font-size: clamp(10px, 1.7vw, 12px); animation: blink 0.9s steps(1) infinite; }

      @keyframes blink { 0%, 100% { opacity: 0; } 50% { opacity: 1; } }

      .audio-btn {
        appearance: none;
        border: 0;
        padding: 8px 10px;
        border-radius: 10px;
        background: rgba(255,255,255,0.55);
        color: var(--ink);
        font-family: "Press Start 2P", sans-serif;
        font-size: clamp(7px, 1.2vw, 9px);
        cursor: pointer;
      }

      .site-logo {
        position: fixed;
        top: 8px;
        left: 8px;
        height: clamp(72px, 12vw, 200px);
        z-index: 10;
        pointer-events: none;
      }

      .github-link { position: fixed; bottom: 14px; right: 14px; font-size: 32px; color: rgba(255, 255, 255, 0.5); z-index: 100; }

      @media (max-width: 900px) {
        .layout { grid-template-columns: 1fr; grid-template-rows: 48vh 52vh; height: 100vh; }
        .left { padding: 16px; align-items: flex-start; }
        .scroll-ui { margin-right: 0; margin-top: 90px; width: 94vw; height: 48vh; aspect-ratio: auto; }
        .right { height: 52vh; }
        .site-logo { left: 50% !important; transform: translateX(-50%); height: 160px; }
        .scroll-inner { inset: 44px 56px 54px 56px; }
      }
    </style>
  </head>

  <body>
    <a href="https://github.com/shwnmnl/Guardian-of-Light" target="_blank" class="github-link"><i class="fab fa-github"></i></a>
    <img src="./assets/stuff/light_logo.png" alt="Logo" class="site-logo" />

    <div class="layout">
      <div class="left">
        <section class="scroll-ui">
          <div class="scroll-inner">
            <div class="scroll-title">Traveler Log <span id="telemetry"></span></div>
            <div class="scroll-subtitle" id="uiSubtitle">Status: Offline</div>
            <div id="uiText" class="scroll-text"></div>
            <div class="scroll-footer">
              <button id="audioBtn" class="audio-btn">Audio: Off</button>
              <span class="scroll-hint" id="uiHint">Waiting...</span>
              <span class="scroll-cursor">â–¶</span>
            </div>
          </div>
        </section>
      </div>
      <div class="right" id="stage"></div>
    </div>

    <script type="module">
      import * as THREE from "three";
      import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";

      const ui = {
        subtitle: document.getElementById("uiSubtitle"),
        text: document.getElementById("uiText"),
        tele: document.getElementById("telemetry"),
        hint: document.getElementById("uiHint"),
        audioBtn: document.getElementById("audioBtn")
      };

      const SNIPPET = {
        BRIGHT: "The light stands at its zenith, bold and unblinking. I endure it with a courteous smile.",
        DAY: "The world stirs and remembers itself. Footsteps, voices, small hopes.",
        DUSK: "The sun bows low, gilding every shadow with farewell. Secrets grow brave here.",
        NIGHT: "Darkness settles like a velvet curtain. You may rest. I will keep watch."
      };

      const local = { isLive: false, lastMsgId: null, currentUrl: null, audioWanted: localStorage.getItem("gol_audio") === "1" };
      const voicePlayer = new Audio();

      // --- THREE.JS (Original Framing & Logic) ---
      const scene = new THREE.Scene();
      const stage = document.getElementById("stage");
      const camera = new THREE.PerspectiveCamera(35, stage.clientWidth / stage.clientHeight, 0.1, 100);
      const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(stage.clientWidth, stage.clientHeight);
      stage.appendChild(renderer.domElement);
      scene.add(new THREE.AmbientLight(0xffffff, 1.0));
      const dl = new THREE.DirectionalLight(0xffffff, 1.2); dl.position.set(2, 4, 2); scene.add(dl);

      let currentModel = { root: null, mixer: null };
      const loader = new GLTFLoader();

      async function loadCharacter(url) {
        if (local.currentUrl === url) return;
        
        const gltf = await loader.loadAsync(url);
        const root = gltf.scene;

        // 1. CLEAR OLD MODEL
        if (currentModel.root) {
          scene.remove(currentModel.root);
          currentModel.root.traverse(n => { if(n.geometry) n.geometry.dispose(); });
        }

        // 2. THE SCALE MAP (Adjust these numbers until they look identical)
        // Lower the number to make a specific character smaller.
        const scaleMap = {
          "night": 0.75,
          "dusk": 0.65,
          "day": 0.75,
          "bright": 0.75
        };

        // We convert the URL to lowercase to ensure the check always works
        const urlLower = url.toLowerCase();
        let chosenScale = 0.12; // Default scale

        for (const [key, value] of Object.entries(scaleMap)) {
          if (urlLower.includes(key)) {
            chosenScale = value;
            break;
          }
        }

        root.scale.set(chosenScale, chosenScale, chosenScale);

        // 3. FIXED POSITIONING
        // This keeps him grounded. Adjust -0.6 to move him up/down globally.
        root.position.set(0, -0.01, 0); 
        root.rotation.y = Math.PI * 0.15; 

        // 4. FIXED CAMERA
        // Keeping the camera at 2.8 distance means the ONLY thing 
        // changing size is the scaleMap above.
        camera.position.set(0, 0, 2.8); 
        camera.lookAt(0, 0, 0);

        scene.add(root);

        const mixer = new THREE.AnimationMixer(root);
        if (gltf.animations[0]) {
          mixer.clipAction(gltf.animations[0]).play();
        }
        
        currentModel = { root, mixer };
        local.currentUrl = url;
      }

      // --- CORE LOGIC ---
      let typeToken = 0;
      async function typewriter(text) {
        const token = ++typeToken;
        ui.text.textContent = "";
        for (const char of text) {
          if (token !== typeToken) return;
          ui.text.textContent += char;
          ui.text.scrollTop = ui.text.scrollHeight;
          await new Promise(r => setTimeout(r, 35));
        }
      }

      function updateAtmo(state) {
        const map = {
          NIGHT: { bg: "url('./assets/bg/night_bg.png')", glb: "./assets/anim/night_dancing.glb" },
          DAY: { bg: "url('./assets/bg/day_bg.png')", glb: "./assets/anim/day_dancing.glb" },
          BRIGHT: { bg: "url('./assets/bg/bright_bg.png')", glb: "./assets/anim/bright_dancing.glb" },
          DUSK: { bg: "url('./assets/bg/dusk_bg.png')", glb: "./assets/anim/dusk_dancing.glb" }
        }[state] || {};
        document.body.style.setProperty("--bg", map.bg);
        loadCharacter(map.glb);
      }

      async function poll() {
        try {
          const res = await fetch("http://localhost:8080/status");
          const data = await res.json();
          
          local.isLive = true;
          ui.tele.textContent = `[SENSOR: ${data.telemetry.value}]`;
          ui.subtitle.textContent = `Status: Live | State: ${data.telemetry.state.toLowerCase()}`;
          updateAtmo(data.telemetry.state);

          // The ID Guard: Only trigger narrative if it's a new message
          if (data.missive.msg_id !== local.lastMsgId) {
            local.lastMsgId = data.missive.msg_id;
            typewriter(data.missive.scroll);
            ui.hint.textContent = "New Missive Received";

            if (local.audioWanted && data.missive.audio) {
              voicePlayer.src = data.missive.audio;
              voicePlayer.play().catch(() => { local.audioWanted = false; updateAudioUI(); });
            }
          }
        } catch (e) {
          if (!local.isLive) {
            const h = new Date().getHours();
            // const ds = (h>=19||h<6)?"NIGHT":(h<11?"DAY":(h<15?"BRIGHT":"DUSK"));
            const ds = "BRIGHT";
            updateAtmo(ds);
            if (!ui.text.textContent) ui.text.textContent = SNIPPET[ds];
          }
        }
      }

      function updateAudioUI() {
        ui.audioBtn.textContent = local.audioWanted ? "Audio: On" : "Audio: Off";
        localStorage.setItem("gol_audio", local.audioWanted ? "1" : "0");
      }

      ui.audioBtn.addEventListener("click", () => {
        local.audioWanted = !local.audioWanted;
        updateAudioUI();
        if (!local.audioWanted) voicePlayer.pause();
      });

      updateAudioUI();
      setInterval(poll, 1200);
      
      const clk = new THREE.Clock();
      function anim() {
        requestAnimationFrame(anim);
        if (currentModel.mixer) currentModel.mixer.update(clk.getDelta());
        renderer.render(scene, camera);
      }
      anim();
      window.addEventListener("resize", () => {
        renderer.setSize(stage.clientWidth, stage.clientHeight);
        camera.aspect = stage.clientWidth / stage.clientHeight;
        camera.updateProjectionMatrix();
      });
    </script>
  </body>
</html>